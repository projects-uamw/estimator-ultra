<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNITED ESTIMATOR APP - Portable</title>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- jsPDF -->
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap');

        :root {
            --primary: #fbbf24;
            /* Yellow */
            --bg-dark: #121212;
            /* Gray */
            --card-bg: #1e1e1e;
            /* Gray */
            --text-main: #f8fafc;
            --text-muted: #9ca3af;
            --border: #374151;
            --accent-blue: #3b82f6;
            /* Blue */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0.75rem;
        }

        @media (min-width: 768px) {
            .container {
                padding: 2rem;
            }
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
        }

        @media (min-width: 640px) {
            .card {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
        }

        .grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }

        @media (min-width: 640px) {
            .grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        h1,
        h2,
        h3 {
            font-family: 'Outfit', sans-serif;
            color: var(--primary);
            margin-top: 0;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            min-height: 44px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 0.9375rem;
            gap: 0.5rem;
            touch-action: manipulation;
        }

        .btn-primary {
            background: var(--primary);
            color: #000;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            color: white;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            /* iOS zoom fix */
            min-height: 44px;
        }

        @media (min-width: 768px) {

            input,
            select,
            textarea {
                font-size: 0.875rem;
            }
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th,
        td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            font-weight: bold;
        }

        /* Mobile Cards */
        .mobile-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .card-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
        }

        .desktop-only {
            display: none;
        }

        .mobile-only {
            display: block;
        }

        @media (min-width: 768px) {
            .desktop-only {
                display: block;
            }

            .mobile-only {
                display: none;
            }
        }

        header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start !important;
            margin-bottom: 1.5rem !important;
        }

        @media (min-width: 640px) {
            header {
                flex-direction: row;
                align-items: center !important;
                margin-bottom: 2rem !important;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const DEFAULT_SETTINGS = {
            materialWaste: 7,
            fabMultipliers: { 1: 40, 2: 65, 3: 95 },
            instMultipliers: { 1: 30, 2: 50, 3: 75 },
            finishAdder: { mode: 'percent', value: 20 },
            rentalAdder: { mode: 'percent', value: 10 },
            commissionRate: 10,
            profitMargins: { conservative: 40, fair: 35, friends: 30 },
            taxRate: 7
        };

        const formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val);

        function App() {
            const [activeTab, setActiveTab] = useState('project');
            const [settings, setSettings] = useState(DEFAULT_SETTINGS);
            const [users, setUsers] = useState(['Admin', 'Sales 1']);
            const [currentUser, setCurrentUser] = useState('Admin');

            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem('united_history');
                return saved ? JSON.parse(saved) : [];
            });

            useEffect(() => {
                localStorage.setItem('united_history', JSON.stringify(history));
            }, [history]);

            const [projectInfo, setProjectInfo] = useState({
                projectName: '', clientName: '', estimateNumber: 'EST' + Math.floor(Math.random() * 10000),
                date: new Date().toISOString().split('T')[0]
            });
            const [materials, setMaterials] = useState([]);
            const [options, setOptions] = useState({
                fabComplexity: 2, instComplexity: 2,
                hasSpecialFinish: false, hasRental: false,
                equipmentRental: 0, scope: 'full', commissionRateOverride: null
            });

            const estimate = useMemo(() => {
                const subtotal = materials.reduce((s, m) => s + (m.quantity * m.unitCost), 0);
                const Mw = subtotal * (1 + settings.materialWaste / 100);

                const isFab = options.scope === 'full' || options.scope === 'fab';
                const isInst = options.scope === 'full' || options.scope === 'inst';

                const fabCost = isFab ? Mw * (settings.fabMultipliers[options.fabComplexity] / 100) : 0;
                let instCost = isInst ? Mw * (settings.instMultipliers[options.instComplexity] / 100) : 0;

                // Installation Minimum: $450
                if (isInst && instCost > 0 && instCost < 450) {
                    instCost = 450;
                }

                const finish = options.hasSpecialFinish ? Mw * (settings.finishAdder.value / 100) : 0;
                const rental = options.hasRental ? Mw * (settings.rentalAdder.value / 100) : 0;

                const subtotalBasis = Mw + fabCost + instCost + finish + rental + (options.equipmentRental || 0);
                const commRate = options.commissionRateOverride !== null ? options.commissionRateOverride : settings.commissionRate;

                const variants = Object.entries(settings.profitMargins).map(([key, margin]) => {
                    const m = margin / 100;
                    const c = commRate / 100;
                    const denom = 1 - m - c;
                    let price = denom > 0 ? subtotalBasis / denom : 0;
                    const earnings = price * m;
                    const commission = price * c;
                    const tax = price * (settings.taxRate / 100);
                    const total = price + tax;
                    return { key, margin, subtotal: price, tax, total, earnings, commission, commRate };
                });

                return { subtotal, Mw, fabCost, instCost, subtotalBasis, variants };
            }, [materials, settings, options]);

            const addToHistory = () => {
                const newEntry = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString(),
                    projectInfo: { ...projectInfo },
                    materials: [...materials],
                    options: { ...options },
                    estimate: estimate
                };
                setHistory([newEntry, ...history]);
                alert('Guardado en historial!');
            };

            const exportPDF = () => {
                const doc = new jspdf.jsPDF();
                const margin = 14;
                const colorBlue = [33, 53, 110];
                const colorGray = [100, 100, 100];

                // Logo (Using the same base64 as React app)
                const LOGO_BASE64 = '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\n' +
                    'vev66fXpS++v2mRBeT09mUvWclhK9M9v7R+C+n7D9B/S/o8vE6Inm9HfiLzOn6S83H8P9p0X+vX9AsPAt3WivXunfP/0XBEu/AExppqH07bsTwZIZEM0M0mTyYAkEkHHA0DP6zIOnD6l+I/9W99rU8F2ie0vS70A+OfN6409S++v2maQpA8fepOem7p4p84xE99ftM75df4Vg76Y719r2XIdf071WfMvU9ZNo8S76m+D+un0m0Yqf4N/7OwS6zI0vSND9dfuMJ0YisY9CnyHUPtP/fvt/Xz/vWf/7+vlS76+jU7O0vAnmNn8mYToOAnl/H9vP50DhrwiWfg3BmK4vAt2/n/f38/9W/x8867qAkKByzXn/fP7f6X/zZ6v6C9Y807D/+fzf6n99/Tz3mX96R0H26L6pD7FfP/9v9P+hf7oY8xR/AeyD/g0xLRE9Anv/TfS/v7f/L6t6Fvx7/4Jg8fvRE6mZ9//v5//N/3t9xrfvDxAs+fSp00f/9Pn8v9fnh353OAb8G/Yev0fPH8m9LOfH0q9Pqf5K8p+fP5//N/r/0D9f8e24CFLNCp7YQ8vL/fPz5/P/Xp8S7vX6v+zN9P8P/v8S7Uv3B497D2m/Anv/DTCnDsLeP8Lp/i1H9w+Puz8Uf7EO5S9I8P75+fP5f6f/P/6N5q9I9Ab6vP+v9P+/f/v6p099mP1m8p+fP5//9/r80D9dD3POfRCZscveI/rYfX5D9PAnUvL/fv58/v9v6p+v9M6/U9fPH70v+UvYvLOnKTCZobLInh+NveN++09S99f98/Pn8/9enxT0f18X93p6Uv0lSvVX6P99/XypLhPSv/Xv6Xm9f8vR/ePnT9P/30r/n7x3/u/r/3/1P07GPMXf3+D05v8W9v630v9n+93H2S8mIn58+09S8v9+/nz+//9V/8u275mMvAInUo0f3p9R/p+fP5//9/XzFf/P2L9v/79P7MAnv7+Bn2P5BwAAAAASUVORK5CYII=';

                try {
                    doc.addImage(LOGO_BASE64, 'PNG', margin, 10, 50, 15);
                } catch (e) { }

                doc.setFontSize(22);
                doc.setTextColor(colorBlue[0], colorBlue[1], colorBlue[2]);
                doc.text('ESTIMATE REPORT', 105, 25, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`Salesperson: ${currentUser}`, margin, 35);
                doc.text(`Date: ${projectInfo.date}`, 180, 35);

                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Client: ${projectInfo.clientName || 'N/A'}`, margin, 50);
                doc.text(`Project: ${projectInfo.projectName || 'N/A'}`, margin, 56);

                let currentY = 70;
                const matsData = materials.map(m => [m.description, m.quantity, formatCurrency(m.unitCost), formatCurrency(m.quantity * m.unitCost)]);
                doc.autoTable({ startY: currentY, head: [['Item', 'Qty', 'Price', 'Total']], body: matsData, theme: 'striped', headStyles: { fillStyle: [100, 100, 100] } });

                currentY = doc.lastAutoTable.finalY + 10;
                doc.text("Pricing Summary", margin, currentY);
                currentY += 5;
                const variantData = estimate.variants.map(v => [
                    v.key.toUpperCase(),
                    formatCurrency(v.total),
                    `${v.margin}%`,
                    formatCurrency(v.earnings)
                ]);
                doc.autoTable({ startY: currentY, head: [['Scenario', 'Total', 'Margin', 'Earnings']], body: variantData, headStyles: { fillStyle: colorBlue } });

                doc.save(`Estimate_${projectInfo.projectName || 'United'}.pdf`);
                addToHistory();
            };

            return (
                <div className="container">
                    <header className="flex justify-between items-center" style={{ marginBottom: '2rem' }}>
                        <div className="flex items-center">
                            <div className="logo-container" style={{ marginRight: '1rem' }}>
                                <img src="src/assets/logo.png" alt="Logo" style={{ height: '40px' }} />
                            </div>
                            <div>
                                <h1 style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', margin: 0 }}>UNITED ESTIMATOR</h1>
                                <p className="text-muted" style={{ margin: 0 }}>Vendedor: <strong style={{ color: 'var(--accent-blue)' }}>{currentUser}</strong></p>
                            </div>
                        </div>
                        <div className="flex gap-2" style={{ width: '100%', marginTop: '1rem' }}>
                            <button className="btn btn-outline" style={{ flex: 1 }} onClick={addToHistory}>
                                üíæ <span>Save History</span>
                            </button>
                            <button className="btn btn-primary" style={{ flex: 1 }} onClick={exportPDF}>
                                üìÑ <span>Export PDF</span>
                            </button>
                        </div>
                    </header>

                    <nav className="tabs">
                        {['project', 'materials', 'users', 'history', 'estimate'].map(t => (
                            <div key={t} className={`tab ${activeTab === t ? 'active' : ''}`} onClick={() => setActiveTab(t)} style={{ textTransform: 'capitalize' }}>{t}</div>
                        ))}
                    </nav>

                    {activeTab === 'project' && (
                        <div className="grid">
                            <div className="card">
                                <h3>General Info</h3>
                                <div style={{ marginBottom: '1rem' }}><label>Project Name</label><input value={projectInfo.projectName} onChange={e => setProjectInfo({ ...projectInfo, projectName: e.target.value })} /></div>
                                <div style={{ marginBottom: '1rem' }}><label>Client Name</label><input value={projectInfo.clientName} onChange={e => setProjectInfo({ ...projectInfo, clientName: e.target.value })} /></div>
                            </div>
                            <div className="card">
                                <h3>Scope & Complexity</h3>
                                <label>Project Scope</label>
                                <select value={options.scope} onChange={e => setOptions({ ...options, scope: e.target.value })} style={{ marginBottom: '1rem' }}>
                                    <option value="full">Fabrication + Installation</option>
                                    <option value="fab">Fabrication Only</option>
                                    <option value="inst">Installation Only</option>
                                    <option value="service">Service Only</option>
                                </select>
                                <div style={{ opacity: (options.scope === 'full' || options.scope === 'fab') ? 1 : 0.4, marginBottom: '1rem' }}>
                                    <label>Fabrication Lvl</label>
                                    <div className="flex gap-2">
                                        {[1, 2, 3].map(v => <button key={v} onClick={() => setOptions({ ...options, fabComplexity: v })} className={`btn ${options.fabComplexity === v ? 'btn-primary' : 'btn-outline'}`} style={{ flex: 1 }}>{v}</button>)}
                                    </div>
                                </div>
                                <div style={{ opacity: (options.scope === 'full' || options.scope === 'inst') ? 1 : 0.4, marginBottom: '1rem' }}>
                                    <label>Installation Lvl</label>
                                    <div className="flex gap-2">
                                        {[1, 2, 3].map(v => <button key={v} onClick={() => setOptions({ ...options, instComplexity: v })} className={`btn ${options.instComplexity === v ? 'btn-primary' : 'btn-outline'}`} style={{ flex: 1 }}>{v}</button>)}
                                    </div>
                                </div>

                                <div style={{ marginTop: '1.5rem', borderTop: '1px solid var(--border)', paddingTop: '1rem' }}>
                                    <div style={{ marginBottom: '1rem' }}>
                                        <label>Custom Rental Fee ($)</label>
                                        <input type="number" value={options.equipmentRental} onChange={e => setOptions({ ...options, equipmentRental: parseFloat(e.target.value) || 0 })} placeholder="0.00" />
                                    </div>
                                    <div style={{ marginBottom: '1rem' }}>
                                        <label>Commission Override (%)</label>
                                        <input type="number" value={options.commissionRateOverride || ''} onChange={e => setOptions({ ...options, commissionRateOverride: e.target.value === '' ? null : parseFloat(e.target.value) })} placeholder="Base %" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'materials' && (
                        <div className="card">
                            <div className="flex justify-between items-center mb-4">
                                <h3>Items</h3>
                                <button className="btn btn-primary" onClick={() => setMaterials([...materials, { description: '', quantity: 1, unitCost: 0 }])}>+ Add Item</button>
                            </div>

                            <div className="mobile-only">
                                {materials.map((m, i) => (
                                    <div key={i} className="mobile-card">
                                        <button style={{ position: 'absolute', right: '10px', top: '10px', background: 'transparent', border: 'none', color: '#ef4444', cursor: 'pointer' }} onClick={() => setMaterials(materials.filter((_, idx) => idx !== i))}>‚ùå</button>
                                        <div className="card-row">
                                            <span className="card-label">Description</span>
                                            <input value={m.description} onChange={e => { const n = [...materials]; n[i].description = e.target.value; setMaterials(n); }} placeholder="Item..." style={{ width: '180px' }} />
                                        </div>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem', marginTop: '0.5rem' }}>
                                            <div>
                                                <span className="card-label">Qty</span>
                                                <input type="number" value={m.quantity} onChange={e => { const n = [...materials]; n[i].quantity = parseFloat(e.target.value) || 0; setMaterials(n); }} />
                                            </div>
                                            <div>
                                                <span className="card-label">Price</span>
                                                <input type="number" value={m.unitCost} onChange={e => { const n = [...materials]; n[i].unitCost = parseFloat(e.target.value) || 0; setMaterials(n); }} />
                                            </div>
                                        </div>
                                        <div style={{ textAlign: 'right', marginTop: '0.5rem', fontWeight: 'bold' }}>
                                            Total: <span style={{ color: 'var(--primary)' }}>{formatCurrency((m.quantity || 0) * (m.unitCost || 0))}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="table-container desktop-only">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Qty</th>
                                            <th>Price</th>
                                            <th style={{ textAlign: 'right' }}>Total</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {materials.map((m, i) => (
                                            <tr key={i}>
                                                <td style={{ padding: '0.25rem 0' }}><input value={m.description} onChange={e => { const n = [...materials]; n[i].description = e.target.value; setMaterials(n); }} placeholder="Item..." /></td>
                                                <td style={{ width: '80px' }}><input type="number" value={m.quantity} onChange={e => { const n = [...materials]; n[i].quantity = parseFloat(e.target.value) || 0; setMaterials(n); }} /></td>
                                                <td style={{ width: '100px' }}><input type="number" value={m.unitCost} onChange={e => { const n = [...materials]; n[i].unitCost = parseFloat(e.target.value) || 0; setMaterials(n); }} /></td>
                                                <td style={{ fontWeight: 'bold', textAlign: 'right' }}>{formatCurrency((m.quantity || 0) * (m.unitCost || 0))}</td>
                                                <td style={{ width: '40px', textAlign: 'right' }}><button onClick={() => setMaterials(materials.filter((_, idx) => idx !== i))}>‚ùå</button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {activeTab === 'history' && (
                        <div className="card">
                            <h3>Saved Estimates</h3>
                            {history.length === 0 ? <p className="text-muted">No history found.</p> : history.map(entry => (
                                <div key={entry.id} className="card p-4 flex justify-between items-center" style={{ marginBottom: '0.5rem' }}>
                                    <div><strong>{entry.projectInfo.projectName}</strong><br /><small className="text-muted">{entry.timestamp}</small></div>
                                    <button className="btn btn-outline" onClick={() => { setProjectInfo(entry.projectInfo); setMaterials(entry.materials); setOptions(entry.options); setActiveTab('project'); }}>Load</button>
                                </div>
                            ))}
                        </div>
                    )}

                    {activeTab === 'users' && (
                        <div className="card">
                            <h3>Vendedores / Salespeople</h3>
                            <div className="flex gap-2" style={{ marginBottom: '1rem' }}>
                                <input value={currentUser} onChange={e => { }} placeholder="Active User" disabled style={{ opacity: 0.6 }} />
                                <span className="badge">Active</span>
                            </div>
                            <div className="grid">
                                {users.map(u => (
                                    <div key={u} className={`card p-3 flex justify-between items-center ${currentUser === u ? 'glass' : ''}`} style={{ marginBottom: '0.5rem', cursor: 'pointer', border: currentUser === u ? '2px solid var(--primary)' : '1px solid var(--border)' }} onClick={() => setCurrentUser(u)}>
                                        <span>{u}</span>
                                        {currentUser === u && <span style={{ color: 'var(--primary)' }}>‚úì</span>}
                                    </div>
                                ))}
                            </div>
                            <div className="mt-4 flex gap-2">
                                <input id="new-user-input" placeholder="New Salesperson Name" />
                                <button className="btn btn-primary" onClick={() => { const val = document.getElementById('new-user-input').value; if (val) { setUsers([...users, val]); document.getElementById('new-user-input').value = ''; } }}>Add</button>
                            </div>
                        </div>
                    )}

                    {activeTab === 'estimate' && (
                        <div className="grid">
                            {estimate.variants.map(v => (
                                <div key={v.key} className="card">
                                    <h4>{v.key.toUpperCase()}</h4>
                                    <h2>{formatCurrency(v.total)}</h2>
                                    <div style={{ fontSize: '0.8rem' }}>Com: {formatCurrency(v.commission)} | Gain: {formatCurrency(v.earnings)}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>